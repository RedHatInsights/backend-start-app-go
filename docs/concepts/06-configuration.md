# Configuration and clowder

To customize our app across environments we need some configuration.
In addition to standard application configuration
we need to consume configuration from Red Hat Insights deployer [clowder](https://github.com/RedHatInsights/clowder).

## Basic configuration

We define structure `config` in `internal/config/config.go` to hold all our configuration variables.
We have nested structures grouping configuration variables by category.
We export these categories by referencing them by exported variables on package level `Category = &config.Category`.

Container application configuration is mostly based on environment variables.
We want to have all our environments close.
We load all configuration from environment variables.
To configure our app locally for development and unit testing,
we will use `.env` files that stay close production setup.

To make this easy locally, we provide example configuration,
that can be regenerated by `make generate-example-config`.

To load configuration just run `Initialize` with the .env file as parameter.
In the container this file does not exist and Initialize method will load config from environment.

```go
config.Initialize("config/api.env")
```

## Clowder

We will touch Clowder more during deployments as it is mainly a deployer operator.
But as a deployer it wraps up many integrations to other services in production environments.
Most notably for now it holds configurations of Database and Cloudwatch.
Clowder adds these in a file in a container layer.
There is a [shared ConsoleDot library](https://github.com/redhatinsights/app-common-go)
that loads this file for you and parses the config into go struct.

Following snippet overrides Database and Cloudwatch config with Clowder provided config.

```go
import clowder "github.com/redhatinsights/app-common-go/pkg/api/v1"

if clowder.IsClowderEnabled() {
    cfg := clowder.LoadedConfig

    // database
    config.Database.Host = cfg.Database.Hostname
    config.Database.Port = uint16(cfg.Database.Port)
    config.Database.User = cfg.Database.Username
    config.Database.Password = cfg.Database.Password
    config.Database.Name = cfg.Database.Name

    // cloudwatch (is blank in ephemeral)
    cw := cfg.Logging.Cloudwatch
    if cw.Region != "" && cw.AccessKeyId != "" && cw.SecretAccessKey != "" && cw.LogGroup != "" {
        config.Cloudwatch.Enabled = true
        config.Cloudwatch.Key = cw.AccessKeyId
        config.Cloudwatch.Secret = cw.SecretAccessKey
        config.Cloudwatch.Region = cw.Region
        config.Cloudwatch.Group = cw.LogGroup
    }
}
```

## Use it :)

Now the config package holds all your configuration at the fingertip.
You can access it anywhere from your app by `config.Category.value`.

Remember the hardcoded http port?
Now we can use `config.Application.Port` to configure it! :)