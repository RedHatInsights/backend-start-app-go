<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://example.com/concepts/07-database/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Database - Go basic concepts</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Database";
        var mkdocs_page_input_path = "concepts/07-database.md";
        var mkdocs_page_url = "/concepts/07-database/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Go basic concepts
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Concepts</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../01-documentation/">Documentation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../02-makefile/">Makefile</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../03-building/">Building</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../04-routing/">Routing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../05-logging/">Logging</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../06-configuration/">Configuration</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Database</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#migrations">Migrations</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#code-structure">Code structure</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#db-package">DB package</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#dao">DAO</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#model">Model</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#dao-methods">DAO methods</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#dao-initialization">DAO initialization</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#using-dao-from-services">Using DAO from services</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../08-openapi/">OpenAPI</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../09-testing/">Testing</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Go basic concepts</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Concepts &raquo;</li>
      <li>Database</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="database">Database</h1>
<p>When we want to keep state, we most likely want a relational database for our service.
ConsoleDot platform has settled on using PostgreSQL for all apps.
This give apps clear choice for drivers, we can build our service with only single database in mind.</p>
<p>When building a go application we could use <a href="https://gorm.io/">GORM</a> that deals with any database and has many ORM features.
In this service tho, we expect to the database model being quite simple and use low level drivers.
This gives us much more power to use pure go objects and strong typing.</p>
<h2 id="migrations">Migrations</h2>
<p>We use simple tool tern for migrations and migrations written in pure SQL.
It allows to lock database during migrations.
We use go embedding for migrations, so migrations are embedded into the migration binary.
We are adding another binary for migrations
and also a make target <code>make migrate</code> to run this binary.</p>
<h2 id="code-structure">Code structure</h2>
<h3 id="db-package">DB package</h3>
<p>We keep database initialization in a separate package.
Here we just initialize the database connection global pool that can be accessed from other packages.
Initialization <code>db.Initialize</code> accepts schema, we will use this for integration testing later on.</p>
<h3 id="dao">DAO</h3>
<p>To organize our code, we want some structure and this service uses Data access objects.
These are objects that abstract the data fetching process and define data access interfaces.</p>
<p>This allows for easy database abstraction.
We will use this during unit testing, to stub away database.</p>
<h3 id="model">Model</h3>
<p>Model is simple data structure that represents an entity of state.</p>
<h2 id="dao-methods">DAO methods</h2>
<p>Example dao method, that accepts a model and saves it in a database.</p>
<pre><code class="language-go">// internal/dao/pgx/hello.go

func (x *helloDaoPgx) Record(ctx context.Context, hello *models.Hello) error {
    query := `
        INSERT INTO hellos (from, to, message)
        VALUES ($1, $2, $3) RETURNING id`

    err := db.Pool.QueryRow(ctx, query, hello.From, hello.To, hello.Message).Scan(&amp;hello.ID)
    if err != nil {
        return fmt.Errorf(&quot;pgx error: %w&quot;, err)
    }
    return nil
}
</code></pre>
<p>In the same file you can find also a <code>List</code> method for further examples.</p>
<h2 id="dao-initialization">DAO initialization</h2>
<p>In the dao package, we have only the interfaces of the DAO implementations.
For each DAO we have a getter, that allows us to initialize the required DAO.</p>
<p>Our <code>GetHello</code> function returns the implementation of the Hello storage.
In the implementation of this dao, we use the <code>init</code> trick to assign the implementation getter.</p>
<pre><code class="language-go">// internal/dao/pgx/hello.go

func init() {
  dao.GetHelloDao = getHelloDao
}

type helloDaoPgx struct{}

func getHelloDao(ctx context.Context) dao.HelloDao {
  return &amp;helloDaoPgx{}
}
</code></pre>
<h2 id="using-dao-from-services">Using DAO from services</h2>
<p>In our service handlers, we just want to initialize the implementation.
These files should not care what the implementation is and only cares about it implementing the interface.</p>
<pre><code class="language-go">helloDao := dao.GetHelloDao(r.Context())
hellos, err := helloDao.List(r.Context(), 100, 0)
</code></pre>
<p>For simplicity, we are using a static limit <code>100</code> and offset <code>0</code>.</p>
<p>Where do we initialize the implementation?
In the main of our API!
We are choosing the implementation per binary, so we can switch implementation for tests.
It's a bit inconvenient as it can easily be forgotten,
but the panic caused by it, is easily recognizable.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../06-configuration/" class="btn btn-neutral float-left" title="Configuration"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../08-openapi/" class="btn btn-neutral float-right" title="OpenAPI">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../06-configuration/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../08-openapi/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
